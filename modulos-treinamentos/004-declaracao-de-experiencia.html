<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o de Certifica√ß√µes | Academy</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary: #4f46e5; 
            --primary-hover: #4338ca; 
            --border: #e2e8f0; 
            --bg: #f8fafc; 
            --text-main: #0f172a; 
            --text-muted: #64748b;
            --white: #ffffff;
        }

        * { box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { margin: 0; background-color: var(--bg); color: var(--text-main); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        
        /* HEADER */
        .app-header { 
            height: 64px; background: var(--white); border-bottom: 1px solid var(--border); 
            display: flex; align-items: center; padding: 0 32px; justify-content: space-between; 
            flex-shrink: 0; z-index: 50; box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        }
        .header-title { font-size: 18px; font-weight: 800; letter-spacing: -0.025em; color: var(--primary); }

        /* --- VIS√ÉO 1: LISTA (DASHBOARD) --- */
        #view-lista { flex: 1; display: flex; flex-direction: column; overflow: hidden; animation: fadeIn 0.3s ease; }
        .filter-bar { background: var(--white); padding: 20px 32px; border-bottom: 1px solid var(--border); display: flex; gap: 16px; align-items: center; }
        .search-input { flex: 1; height: 44px; padding: 0 16px; border: 1px solid var(--border); border-radius: 10px; font-size: 14px; background: #f1f5f9; transition: all 0.2s; }
        .search-input:focus { border-color: var(--primary); background: white; outline: none; box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1); }
        
        .table-container { flex: 1; overflow: auto; padding: 32px; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; background: var(--white); border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        th { background: #f8fafc; text-align: left; padding: 16px; font-size: 11px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 1px solid var(--border); }
        td { padding: 16px; border-bottom: 1px solid #f1f5f9; font-size: 14px; color: #334155; }
        tr:last-child td { border-bottom: none; }
        tr:hover td { background: #fcfdfe; }

        /* BOT√ïES DE A√á√ÉO NA TABELA */
        .btn-action { 
            width: 36px; height: 36px; border-radius: 10px; border: 1px solid transparent;
            cursor: pointer; display: inline-flex; align-items: center; justify-content: center;
            font-size: 16px; transition: all 0.2s; margin-left: 4px;
        }
        .btn-view { background: #eff6ff; color: #2563eb; border-color: #dbeafe; }
        .btn-view:hover { background: #2563eb; color: white; }
        .btn-edit { background: #f5f3ff; color: #7c3aed; border-color: #ede9fe; }
        .btn-edit:hover { background: #7c3aed; color: white; }
        .btn-delete { background: #fef2f2; color: #dc2626; border-color: #fee2e2; }
        .btn-delete:hover { background: #dc2626; color: white; }

        /* --- VIS√ÉO 2: FORMUL√ÅRIO (EDITOR) --- */
        #view-formulario { flex: 1; display: none; height: 100%; overflow: hidden; animation: slideIn 0.3s ease; }
        .form-container { display: flex; height: 100%; }
        
        .sidebar { width: 340px; padding: 32px; background: var(--white); border-right: 1px solid var(--border); display: flex; flex-direction: column; gap: 24px; overflow-y: auto; }
        .main-form { flex: 1; padding: 48px; overflow-y: auto; background: var(--bg); display: flex; flex-direction: column; align-items: center; }
        .form-card-content { width: 100%; max-width: 800px; background: var(--white); padding: 40px; border-radius: 16px; border: 1px solid var(--border); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1); }

        .section-title { font-size: 11px; font-weight: 800; color: var(--text-muted); text-transform: uppercase; margin-bottom: 20px; letter-spacing: 0.1em; border-bottom: 2px solid var(--bg); padding-bottom: 8px; }
        label { font-size: 12px; font-weight: 700; display: block; margin-bottom: 8px; color: #475569; }
        select, input, textarea { width: 100%; padding: 12px 16px; border: 1px solid var(--border); border-radius: 10px; font-size: 14px; margin-bottom: 20px; background: #fff; transition: all 0.2s; }
        select:focus, input:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1); }

        .evidence-button { padding: 20px; border: 1px solid var(--border); border-radius: 12px; cursor: pointer; margin-bottom: 12px; background: #fcfdfe; transition: all 0.2s; border-left: 4px solid transparent; }
        .evidence-button:hover { background: #f8fafc; border-color: var(--primary); }
        .evidence-button.active { border-color: var(--primary); border-left-color: var(--primary); background: #eff6ff; color: var(--primary); }

        .footer { margin-top: 32px; display: flex; justify-content: flex-end; gap: 16px; border-top: 1px solid var(--border); padding-top: 32px; width: 100%; }
        
        /* BOT√ïES GERAIS */
        .btn { height: 44px; padding: 0 24px; border-radius: 10px; font-weight: 700; cursor: pointer; border: none; font-size: 14px; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.4); }
        .btn-primary:hover { background: var(--primary-hover); transform: translateY(-1px); }
        .btn-outline { background: white; border: 1px solid var(--border); color: var(--text-muted); }
        .btn-outline:hover { background: #f8fafc; color: var(--text-main); }

        .badge { padding: 6px 10px; border-radius: 8px; font-size: 10px; font-weight: 800; letter-spacing: 0.05em; }
        .readonly-mode input, .readonly-mode select, .readonly-mode textarea { background-color: #f8fafc; color: #64748b; border-style: dashed; pointer-events: none; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { transform: translateX(20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .admin-only { display: none; }
    </style>
</head>
<body>

    <header class="app-header">
        <div class="header-title">ACADEMY // CERTIFICA√á√ïES</div>
        <div id="header-actions">
            <button class="btn btn-primary admin-only" id="btnTopNovo" onclick="window.abrirFormulario()">
                <span>‚ûï</span> Nova Homologa√ß√£o
            </button>
        </div>
    </header>

    <div id="view-lista">
        <div class="filter-bar">
            <input type="text" id="searchBox" class="search-input" placeholder="Pesquisar por colaborador, compet√™ncia ou tipo..." onkeyup="window.filtrar()">
            <select id="filterTipo" onchange="window.filtrar()">
                <option value="TODOS">Todos os tipos</option>
                <option value="CERTIFICADO">Certificados</option>
                <option value="NOTORIO">Not√≥rio Saber</option>
            </select>
        </div>
        <div class="table-container">
            <table id="homologTable">
                <thead>
                    <tr>
                        <th>Colaborador</th>
                        <th>Compet√™ncia Alvo</th>
                        <th>Tipo</th>
                        <th>Data</th>
                        <th>Nota</th>
                        <th style="text-align: right;">A√ß√µes</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="view-formulario">
        <div class="form-container" id="formWrapper">
            <aside class="sidebar">
                <div class="section-title">1. Configura√ß√£o</div>
                <label>Colaborador</label>
                <select id="selectColaborador"><option value="">Carregando...</option></select>
                
                <label>Compet√™ncia do Cat√°logo</label>
                <select id="selectTreinamento"><option value="">Carregando...</option></select>

                <div style="margin-top: 12px;" id="tipoEvidenciaBox">
                    <div class="section-title">2. Tipo de Evid√™ncia</div>
                    <div id="btn-cert" class="evidence-button active" onclick="window.selectMode('certificado', this)">
                        <b>Certificado Externo</b><br><small style="font-weight: 400; opacity: 0.8;">Documento de outra institui√ß√£o</small>
                    </div>
                    <div id="btn-notorio" class="evidence-button" onclick="window.selectMode('notorio', this)">
                        <b>Not√≥rio Saber</b><br><small style="font-weight: 400; opacity: 0.8;">Parecer t√©cnico do RH</small>
                    </div>
                </div>
            </aside>

            <main class="main-form">
                <div class="form-card-content">
                    <h2 id="form-title" style="margin: 0 0 32px 0; font-size: 22px; font-weight: 800; color: var(--text-main);">Nova Homologa√ß√£o</h2>

                    <div id="form-certificado">
                        <div style="display: flex; gap: 24px;">
                            <div style="flex: 2;">
                                <label>Institui√ß√£o Emissora</label>
                                <input type="text" id="certInstituicao" value="Edesoft-Academy" readonly>
                                <div id="boxCheckEdesoft" style="display: flex; align-items: center; gap: 8px;">
                                    <input type="checkbox" id="checkEdesoft" checked onchange="window.toggleInstituicao(this.checked)" style="width: auto; margin: 0;"> 
                                    <span style="font-size: 12px; color: var(--text-muted);">Institui√ß√£o Padr√£o</span>
                                </div>
                            </div>
                            <div style="flex: 1;">
                                <label>Data de Conclus√£o</label>
                                <input type="date" id="certData">
                            </div>
                        </div>
                        <div style="margin-top: 32px; display: flex; gap: 24px; align-items: flex-start;">
                            <div style="flex: 1;">
                                <label>Nota / Avalia√ß√£o</label>
                                <input type="number" id="certNota" placeholder="N/A" readonly step="0.1">
                                <div id="boxCheckNota" style="display: flex; align-items: center; gap: 8px;">
                                    <input type="checkbox" id="checkNotaNA" checked onchange="window.toggleNota(this.checked)" style="width: auto; margin: 0;"> 
                                    <span style="font-size: 12px; color: var(--text-muted);">N√£o se aplica</span>
                                </div>
                            </div>
                            <div style="flex: 2;">
                                <label>Link de Valida√ß√£o (Opcional)</label>
                                <input type="url" id="certLink" placeholder="https://validador.com/...">
                            </div>
                        </div>
                    </div>

                    <div id="form-notorio" style="display: none;">
                        <label>Justificativa do Parecer T√©cnico</label>
                        <textarea id="notorioJustificativa" placeholder="Descreva os motivos, testes ou hist√≥ricos que validam esta compet√™ncia..."></textarea>
                        <div style="display: flex; gap: 24px; margin-top: 8px;">
                            <div style="flex: 1;">
                                <label>Aprovador (Gestor/Especialista)</label>
                                <input type="text" id="notorioAprovador" placeholder="Nome do respons√°vel">
                            </div>
                        </div>
                        <div id="boxCheckRH" style="background: #f8fafc; padding: 16px; border-radius: 12px; border: 1px solid var(--border); margin-top: 10px; display: flex; align-items: center; gap: 12px;">
                            <input type="checkbox" id="checkRH" style="width: 20px; height: 20px; margin: 0;"> 
                            <span style="font-size: 13px; font-weight: 600;">Confirmo a valida√ß√£o t√©cnica desta compet√™ncia conforme normas internas.</span>
                        </div>
                    </div>

                    <div class="footer">
                        <button class="btn btn-outline" onclick="window.voltarParaLista()">Cancelar</button>
                        <button class="btn btn-primary" id="btnSalvar" onclick="window.salvarHomologacao()">Gravar Registro</button>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script type="module">
        import { DBHandler } from '../bd-treinamentos/db-handler.js';

        let DADOS_LISTA = [];
        let currentId = null;
        let currentMode = 'CERTIFICADO';

        document.addEventListener('DOMContentLoaded', async () => {
            const session = JSON.parse(localStorage.getItem('rh_session'));
            if (session?.role === 'ADMIN') {
                document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'inline-flex');
            }
            await carregarCombos();
            await window.carregarLista();
        });

        async function carregarCombos() {
            try {
                const colabs = await DBHandler.listarColaboradores({ somenteAtivos: true });
                document.getElementById('selectColaborador').innerHTML = '<option value="">Selecione o colaborador...</option>' + 
                    colabs.map(c => `<option value="${c.id}">${c.nome}</option>`).join('');

                const { treinamentos } = await DBHandler.carregarDadosIniciais();
                document.getElementById('selectTreinamento').innerHTML = '<option value="">Selecione a compet√™ncia...</option>' + 
                    treinamentos.map(t => `<option value="${t.id}">${t.nome}</option>`).join('');
            } catch (e) { console.error(e); }
        }

        // --- NAVEGA√á√ÉO SPA ---

        window.abrirFormulario = async (id = null, isView = false) => {
            currentId = id;
            document.getElementById('view-lista').style.display = 'none';
            document.getElementById('view-formulario').style.display = 'block';
            document.getElementById('btnTopNovo').style.display = 'none';

            if (id) {
                const dado = await DBHandler.buscarHomologacaoPorId(id);
                preencherCampos(dado);
                travarCampos(isView);
                document.getElementById('form-title').textContent = isView ? "Visualizar Registro" : "Editar Registro";
            } else {
                resetarFormulario();
                travarCampos(false);
                document.getElementById('form-title').textContent = "Nova Homologa√ß√£o";
            }
        };

        window.voltarParaLista = () => {
            document.getElementById('view-lista').style.display = 'flex';
            document.getElementById('view-formulario').style.display = 'none';
            const session = JSON.parse(localStorage.getItem('rh_session'));
            if(session.role === 'ADMIN') document.getElementById('btnTopNovo').style.display = 'inline-flex';
            window.carregarLista();
        };

        // --- L√ìGICA DA TABELA ---

        window.carregarLista = async () => {
            try {
                DADOS_LISTA = await DBHandler.listarHomologacoes();
                renderizarTabela(DADOS_LISTA);
            } catch (e) { console.error(e); }
        };

        function renderizarTabela(lista) {
            const tbody = document.querySelector("#homologTable tbody");
            const session = JSON.parse(localStorage.getItem('rh_session'));
            
            tbody.innerHTML = lista.map(item => `
                <tr>
                    <td><strong>${item.colaboradores?.nome || '‚Äî'}</strong></td>
                    <td>${item.treinamentos?.nome || '‚Äî'}</td>
                    <td><span class="badge ${item.atividade_externa === 'NOTORIO' ? 'type-notorio' : 'type-cert'}">${item.atividade_externa || 'CERTIFICADO'}</span></td>
                    <td>${item.data_homologacao ? new Date(item.data_homologacao).toLocaleDateString('pt-BR') : '‚Äî'}</td>
                    <td>${item.nota || 'N/A'}</td>
                    <td style="text-align: right; white-space: nowrap;">
                        <button class="btn-action btn-view" onclick="window.abrirFormulario(${item.id}, true)" title="Visualizar">üëÅÔ∏è</button>
                        ${session.role === 'ADMIN' ? `
                            <button class="btn-action btn-edit" onclick="window.abrirFormulario(${item.id}, false)" title="Editar">‚úèÔ∏è</button>
                            <button class="btn-action btn-delete" onclick="window.deletarRegistro(${item.id})" title="Excluir">üóëÔ∏è</button>
                        ` : ''}
                    </td>
                </tr>
            `).join('');
        }

        window.filtrar = () => {
            const busca = document.getElementById('searchBox').value.toLowerCase();
            const tipo = document.getElementById('filterTipo').value;
            const filtrados = DADOS_LISTA.filter(i => {
                const matchBusca = i.colaboradores?.nome?.toLowerCase().includes(busca) || i.treinamentos?.nome?.toLowerCase().includes(busca);
                const matchTipo = tipo === 'TODOS' || i.atividade_externa === tipo;
                return matchBusca && matchTipo;
            });
            renderizarTabela(filtrados);
        };

        // --- L√ìGICA DO FORMUL√ÅRIO ---

        window.selectMode = (mode, el) => {
            currentMode = mode.toUpperCase();
            document.querySelectorAll('.evidence-button').forEach(b => b.classList.remove('active'));
            el.classList.add('active');
            document.getElementById('form-certificado').style.display = mode === 'certificado' ? 'block' : 'none';
            document.getElementById('form-notorio').style.display = mode === 'notorio' ? 'block' : 'none';
        };

        window.toggleInstituicao = (check) => {
            const input = document.getElementById('certInstituicao');
            input.value = check ? "Edesoft-Academy" : "";
            input.readOnly = check;
        };

        window.toggleNota = (check) => {
            const input = document.getElementById('certNota');
            input.readOnly = check;
            input.placeholder = check ? "N/A" : "0.0";
            if (check) input.value = "";
        };

        window.deletarRegistro = async (id) => {
            if(!confirm("Tem certeza que deseja excluir esta homologa√ß√£o? Esta a√ß√£o √© irrevers√≠vel.")) return;
            try {
                await DBHandler.excluirHomologacao(id);
                alert("Registro removido com sucesso.");
                window.carregarLista();
            } catch (e) { alert("Erro ao excluir: " + e.message); }
        };

        window.salvarHomologacao = async () => {
            const session = JSON.parse(localStorage.getItem('rh_session'));
            const payload = {
                colaborador_id: document.getElementById('selectColaborador').value,
                treinamento_id: document.getElementById('selectTreinamento').value,
                usuario_registro: session.user,
                atividade_externa: currentMode,
                data_homologacao: currentMode === 'CERTIFICADO' ? document.getElementById('certData').value : new Date().toISOString().split('T')[0],
                nota: (currentMode === 'CERTIFICADO' && !document.getElementById('checkNotaNA').checked) ? document.getElementById('certNota').value : null,
                instrutor: currentMode === 'CERTIFICADO' ? document.getElementById('certInstituicao').value : document.getElementById('notorioAprovador').value,
                observacoes: currentMode === 'NOTORIO' ? document.getElementById('notorioJustificativa').value : (document.getElementById('certLink').value || null)
            };

            if (!payload.colaborador_id || !payload.treinamento_id) return alert("Selecione Colaborador e Compet√™ncia.");

            try {
                await DBHandler.salvarHomologacao({ ...(currentId ? { id: currentId } : {}), ...payload });
                alert("‚úÖ Registro gravado com sucesso!");
                window.voltarParaLista();
            } catch (e) { alert("Erro ao salvar: " + e.message); }
        };

        // --- AUXILIARES ---

        function preencherCampos(d) {
            document.getElementById('selectColaborador').value = d.colaborador_id;
            document.getElementById('selectTreinamento').value = d.treinamento_id;
            if (d.atividade_externa === 'NOTORIO') {
                window.selectMode('notorio', document.getElementById('btn-notorio'));
                document.getElementById('notorioJustificativa').value = d.observacoes || "";
                document.getElementById('notorioAprovador').value = d.instrutor || "";
                document.getElementById('checkRH').checked = true;
            } else {
                window.selectMode('certificado', document.getElementById('btn-cert'));
                document.getElementById('certInstituicao').value = d.instrutor || "Edesoft-Academy";
                document.getElementById('checkEdesoft').checked = (d.instrutor === "Edesoft-Academy");
                document.getElementById('certData').value = d.data_homologacao;
                document.getElementById('certLink').value = d.observacoes || "";
                if(d.nota) {
                    document.getElementById('checkNotaNA').checked = false;
                    window.toggleNota(false);
                    document.getElementById('certNota').value = d.nota;
                } else {
                    document.getElementById('checkNotaNA').checked = true;
                    window.toggleNota(true);
                }
            }
        }

        function travarCampos(travar) {
            const inputs = document.querySelectorAll('#view-formulario input, #view-formulario select, #view-formulario textarea');
            inputs.forEach(el => el.disabled = travar);
            document.getElementById('btnSalvar').style.display = travar ? 'none' : 'block';
            document.getElementById('boxCheckEdesoft').style.display = travar ? 'none' : 'block';
            document.getElementById('boxCheckNota').style.display = travar ? 'none' : 'block';
            document.getElementById('boxCheckRH').style.display = travar ? 'none' : 'flex';
            document.getElementById('tipoEvidenciaBox').style.pointerEvents = travar ? 'none' : 'auto';
            if(travar) document.getElementById('formWrapper').classList.add('readonly-mode');
            else document.getElementById('formWrapper').classList.remove('readonly-mode');
        }

        function resetarFormulario() {
            document.getElementById('selectColaborador').value = "";
            document.getElementById('selectTreinamento').value = "";
            document.getElementById('certInstituicao').value = "Edesoft-Academy";
            document.getElementById('certInstituicao').readOnly = true;
            document.getElementById('checkEdesoft').checked = true;
            document.getElementById('checkNotaNA').checked = true;
            document.getElementById('certNota').value = "";
            document.getElementById('certData').value = new Date().toISOString().split('T')[0];
            document.getElementById('notorioJustificativa').value = "";
            document.getElementById('notorioAprovador').value = "";
            document.getElementById('checkRH').checked = false;
            window.selectMode('certificado', document.getElementById('btn-cert'));
        }
    </script>
</body>
</html>
