<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o de Certifica√ß√µes | Academy</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #4f46e5; --border: #e2e8f0; --bg: #f8fafc; --text: #1e293b; }
        * { box-sizing: border-box; font-family: 'Inter', sans-serif; }
        
        body { margin: 0; background-color: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; }
        
        /* HEADER */
        .app-header { height: 64px; background: white; border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 24px; justify-content: space-between; flex-shrink: 0; }
        .header-title { font-size: 18px; font-weight: 700; }

        /* FILTROS */
        .filter-bar { background: white; padding: 16px 24px; border-bottom: 1px solid var(--border); display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
        .search-input { flex: 1; min-width: 250px; height: 40px; padding: 0 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; }
        select { height: 40px; padding: 0 12px; border: 1px solid var(--border); border-radius: 8px; background: white; min-width: 160px; font-size: 14px; }

        /* TABELA */
        .table-container { flex: 1; overflow: auto; padding: 24px; }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        th { background: #f1f5f9; text-align: left; padding: 14px 16px; font-size: 12px; font-weight: 700; color: #64748b; text-transform: uppercase; }
        td { padding: 14px 16px; border-bottom: 1px solid #f1f5f9; font-size: 14px; }
        tr:hover { background: #f8fafc; }

        /* STATUS E BOT√ïES */
        .badge { padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 700; text-transform: uppercase; }
        .type-cert { background: #e0e7ff; color: #4338ca; }
        .type-notorio { background: #fef3c7; color: #92400e; }
        
        .btn { height: 40px; padding: 0 16px; border-radius: 8px; font-weight: 600; cursor: pointer; border: 1px solid transparent; font-size: 13px; display: inline-flex; align-items: center; gap: 6px; transition: all 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-ghost { background: transparent; color: #64748b; border: 1px solid var(--border); }
        .btn-ghost:hover { background: #f1f5f9; }
        .btn-icon { padding: 8px; background: #f1f5f9; color: #64748b; border: 1px solid var(--border); border-radius: 6px; cursor: pointer; transition: all 0.2s; font-size: 16px; }
        .btn-icon:hover { background: #e2e8f0; color: var(--text); }
        
        .admin-only { display: none; }
    </style>
</head>
<body>

    <header class="app-header">
        <div class="header-title">üìú Gest√£o de Homologa√ß√µes</div>
        <button class="btn btn-primary admin-only" id="btnNovo" onclick="window.location.href='homologacao-competencia.html'">
            ‚ûï Nova Homologa√ß√£o
        </button>
    </header>

    <div class="filter-bar">
        <input type="text" id="searchBox" class="search-input" placeholder="Pesquisar por colaborador ou curso..." onkeyup="window.filtrar()">
        <select id="filterTipo" onchange="window.filtrar()">
            <option value="TODOS">Tipo: Todos</option>
            <option value="CERTIFICADO">Certificado</option>
            <option value="NOTORIO">Not√≥rio Saber</option>
        </select>
        <button class="btn btn-ghost" onclick="window.limparFiltros()">Limpar Filtros</button>
    </div>

    <div class="table-container">
        <table id="homologTable">
            <thead>
                <tr>
                    <th>Colaborador</th>
                    <th>Compet√™ncia</th>
                    <th>Tipo</th>
                    <th>Data</th>
                    <th>Nota</th>
                    <th style="text-align: right;">A√ß√µes</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
    </div>

    <script type="module">
        import { DBHandler } from '../bd-treinamentos/db-handler.js';

        let DADOS = [];

        document.addEventListener('DOMContentLoaded', async () => {
            const sessionRaw = localStorage.getItem('rh_session');
            if (!sessionRaw) {
                window.top.location.href = '../login.html';
                return;
            }
            const session = JSON.parse(sessionRaw);

            // Controle de visibilidade Admin
            if (session.role === 'ADMIN') {
                document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'inline-flex');
            }

            await carregarLista();
        });

        async function carregarLista() {
            try {
                // Busca os dados reais do Supabase
                DADOS = await DBHandler.listarHomologacoes();
                renderizar(DADOS);
            } catch (e) {
                console.error("Erro ao carregar lista de homologa√ß√µes:", e);
            }
        }

        function renderizar(lista) {
            const tbody = document.querySelector("#homologTable tbody");
            if (!tbody) return;

            if (lista.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding: 40px; color: #64748b;">Nenhum registro encontrado.</td></tr>`;
                return;
            }

            tbody.innerHTML = lista.map(item => {
                const isNotorio = item.atividade_externa === 'NOTORIO_SABER';
                return `
                <tr>
                    <td><strong>${item.colaboradores?.nome || '‚Äî'}</strong></td>
                    <td>${item.treinamentos?.nome || item.atividade_externa || '‚Äî'}</td>
                    <td>
                        <span class="badge ${isNotorio ? 'type-notorio' : 'type-cert'}">
                            ${isNotorio ? 'Not√≥rio Saber' : 'Certificado'}
                        </span>
                    </td>
                    <td>${item.data_homologacao ? new Date(item.data_homologacao).toLocaleDateString('pt-BR') : '‚Äî'}</td>
                    <td>${item.nota !== null ? item.nota : 'N/A'}</td>
                    <td style="text-align: right;">
                        <button class="btn-icon" onclick="window.verDetalhes(${item.id})" title="Visualizar">üëÅÔ∏è</button>
                        <button class="btn-icon admin-only" onclick="window.editar(${item.id})" title="Editar">‚úèÔ∏è</button>
                    </td>
                </tr>
            `;}).join('');
            
            // Re-aplica visibilidade admin para elementos din√¢micos
            const session = JSON.parse(localStorage.getItem('rh_session'));
            if (session.role !== 'ADMIN') {
                document.querySelectorAll('tbody .admin-only').forEach(el => el.style.display = 'none');
            }
        }

        // --- FUN√á√ïES EXPOSTAS AO WINDOW ---

        window.filtrar = () => {
            const busca = document.getElementById('searchBox').value.toLowerCase();
            const tipo = document.getElementById('filterTipo').value;

            const filtrados = DADOS.filter(item => {
                const nomeColab = (item.colaboradores?.nome || "").toLowerCase();
                const nomeCurso = (item.treinamentos?.nome || "").toLowerCase();
                const atividade = (item.atividade_externa || "").toLowerCase();

                const matchBusca = nomeColab.includes(busca) || nomeCurso.includes(busca) || atividade.includes(busca);
                
                const itemTipoReal = item.atividade_externa === 'NOTORIO_SABER' ? 'NOTORIO' : 'CERTIFICADO';
                const matchTipo = tipo === 'TODOS' || itemTipoReal === tipo;

                return matchBusca && matchTipo;
            });
            renderizar(filtrados);
        };

        window.limparFiltros = () => {
            document.getElementById('searchBox').value = "";
            document.getElementById('filterTipo').value = "TODOS";
            renderizar(DADOS);
        };

        window.verDetalhes = (id) => {
            window.location.href = `homologacao-competencia.html?id=${id}&mode=view`;
        };

        window.editar = (id) => {
            window.location.href = `homologacao-competencia.html?id=${id}&mode=edit`;
        };

    </script>
</body>
</html>
