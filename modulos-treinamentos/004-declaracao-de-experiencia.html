<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o de Certifica√ß√µes | Academy</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #4f46e5; --primary-hover: #4338ca; --border: #e2e8f0; --bg: #f8fafc; --text: #1e293b; --muted: #64748b; }
        * { box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { margin: 0; background-color: var(--bg); color: var(--text); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        
        /* HEADER */
        .app-header { height: 60px; background: white; border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 24px; justify-content: space-between; flex-shrink: 0; z-index: 10; }
        .header-title { font-size: 18px; font-weight: 700; }

        /* --- VIS√ÉO 1: LISTA (DASHBOARD) --- */
        #view-lista { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .filter-bar { background: white; padding: 16px 24px; border-bottom: 1px solid var(--border); display: flex; gap: 12px; align-items: center; }
        .search-input { flex: 1; height: 40px; padding: 0 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; }
        .table-container { flex: 1; overflow: auto; padding: 24px; }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        th { background: #f1f5f9; text-align: left; padding: 14px 16px; font-size: 12px; font-weight: 700; color: #64748b; text-transform: uppercase; }
        td { padding: 14px 16px; border-bottom: 1px solid #f1f5f9; font-size: 14px; }
        .badge { padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 700; text-transform: uppercase; }
        .type-cert { background: #e0e7ff; color: #4338ca; }
        .type-notorio { background: #fef3c7; color: #92400e; }

        /* --- VIS√ÉO 2: FORMUL√ÅRIO (CADASTRO) --- */
        #view-formulario { flex: 1; display: none; height: 100%; }
        .form-container { display: flex; height: 100%; }
        .sidebar { width: 320px; padding: 24px; background: white; border-right: 1px solid var(--border); display: flex; flex-direction: column; gap: 20px; }
        .main-form { flex: 1; padding: 40px; overflow-y: auto; background: var(--bg); }
        
        /* CAMPOS */
        label { font-size: 11px; font-weight: 800; display: block; margin-bottom: 6px; color: var(--muted); text-transform: uppercase; }
        select, input, textarea { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; margin-bottom: 10px; }
        input:read-only { background-color: #f1f5f9; cursor: not-allowed; border-style: dashed; }
        
        .evidence-button { padding: 16px; border: 1px solid var(--border); border-radius: 10px; cursor: pointer; margin-bottom: 12px; background: white; }
        .evidence-button.active { border-color: var(--primary); background: #eff6ff; color: var(--primary); }

        .footer { margin-top: 40px; display: flex; justify-content: flex-end; gap: 12px; border-top: 1px solid var(--border); padding-top: 24px; }
        
        /* GERAL */
        .btn { height: 40px; padding: 0 20px; border-radius: 8px; font-weight: 700; cursor: pointer; border: none; font-size: 13px; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-outline { background: white; border: 1px solid var(--border); color: var(--muted); }
        .btn-icon { padding: 6px; background: #f1f5f9; border-radius: 6px; cursor: pointer; border: 1px solid var(--border); }
        .admin-only { display: none; }
    </style>
</head>
<body>

    <header class="app-header">
        <div class="header-title">üìú M√≥dulo de Certifica√ß√µes</div>
        <div id="header-actions">
            <button class="btn btn-primary admin-only" onclick="window.abrirFormulario()">‚ûï Nova Homologa√ß√£o</button>
        </div>
    </header>

    <div id="view-lista">
        <div class="filter-bar">
            <input type="text" id="searchBox" class="search-input" placeholder="Pesquisar colaborador ou curso..." onkeyup="window.filtrar()">
            <select id="filterTipo" onchange="window.filtrar()">
                <option value="TODOS">Todos os tipos</option>
                <option value="CERTIFICADO">Certificados</option>
                <option value="NOTORIO">Not√≥rio Saber</option>
            </select>
        </div>
        <div class="table-container">
            <table id="homologTable">
                <thead>
                    <tr>
                        <th>Colaborador</th>
                        <th>Compet√™ncia</th>
                        <th>Tipo</th>
                        <th>Data</th>
                        <th>Nota</th>
                        <th style="text-align: right;">A√ß√µes</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="view-formulario">
        <div class="form-container">
            <aside class="sidebar">
                <label>Colaborador</label>
                <select id="selectColaborador"><option value="">Selecione...</option></select>
                
                <label>Compet√™ncia Cat√°logo</label>
                <select id="selectTreinamento"><option value="">Selecione...</option></select>

                <div style="margin-top: 20px;">
                    <label>Tipo de Evid√™ncia</label>
                    <div id="btn-cert" class="evidence-button active" onclick="window.selectMode('certificado', this)">
                        <b>Certificado</b><br><small>Curso externo/interno</small>
                    </div>
                    <div id="btn-notorio" class="evidence-button" onclick="window.selectMode('notorio', this)">
                        <b>Not√≥rio Saber</b><br><small>Valida√ß√£o t√©cnica RH</small>
                    </div>
                </div>
            </aside>

            <main class="main-form">
                <h2 id="form-title">Nova Homologa√ß√£o</h2>

                <div id="form-certificado">
                    <div style="display: flex; gap: 20px;">
                        <div style="flex: 2;">
                            <label>Institui√ß√£o</label>
                            <input type="text" id="certInstituicao" value="Edesoft-Academy" readonly>
                            <input type="checkbox" id="checkEdesoft" checked onchange="window.toggleInstituicao(this.checked)"> <small>Institui√ß√£o Padr√£o</small>
                        </div>
                        <div style="flex: 1;">
                            <label>Data de Conclus√£o</label>
                            <input type="date" id="certData">
                        </div>
                    </div>
                    <div style="margin-top: 20px;">
                        <label>Nota / Avalia√ß√£o</label>
                        <input type="number" id="certNota" placeholder="N/A" readonly>
                        <input type="checkbox" id="checkNotaNA" checked onchange="window.toggleNota(this.checked)"> <small>N√£o se aplica</small>
                    </div>
                </div>

                <div id="form-notorio" style="display: none;">
                    <label>Justificativa do Parecer T√©cnico</label>
                    <textarea id="notorioJustificativa" placeholder="Descreva os motivos da valida√ß√£o..."></textarea>
                    <label>Aprovador T√©cnico (Gestor)</label>
                    <input type="text" id="notorioAprovador" placeholder="Nome do respons√°vel">
                    <input type="checkbox" id="checkRH"> <small>Confirmo a valida√ß√£o t√©cnica desta compet√™ncia.</small>
                </div>

                <div class="footer">
                    <button class="btn btn-outline" onclick="window.voltarParaLista()">Cancelar</button>
                    <button class="btn btn-primary" id="btnSalvar" onclick="window.salvarHomologacao()">Gravar Registro</button>
                </div>
            </main>
        </div>
    </div>

    <script type="module">
        import { DBHandler } from '../bd-treinamentos/db-handler.js';

        let DADOS_LISTA = [];
        let currentId = null;
        let currentMode = 'CERTIFICADO';

        document.addEventListener('DOMContentLoaded', async () => {
            const session = JSON.parse(localStorage.getItem('rh_session'));
            if (session?.role === 'ADMIN') {
                document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'inline-flex');
            }
            await carregarCombos();
            await window.carregarLista();
        });

        async function carregarCombos() {
            const colabs = await DBHandler.listarColaboradores({ somenteAtivos: true });
            document.getElementById('selectColaborador').innerHTML = '<option value="">Selecione...</option>' + 
                colabs.map(c => `<option value="${c.id}">${c.nome}</option>`).join('');

            const { treinamentos } = await DBHandler.carregarDadosIniciais();
            document.getElementById('selectTreinamento').innerHTML = '<option value="">Selecione...</option>' + 
                treinamentos.map(t => `<option value="${t.id}">${t.nome}</option>`).join('');
        }

        // --- GEST√ÉO DE TELAS ---

        window.abrirFormulario = async (id = null, isView = false) => {
            currentId = id;
            document.getElementById('view-lista').style.display = 'none';
            document.getElementById('view-formulario').style.display = 'block';
            document.getElementById('btnNovo').style.display = 'none';

            if (id) {
                const dado = await DBHandler.buscarHomologacaoPorId(id);
                preencherFormulario(dado);
                if (isView) travarFormulario();
                document.getElementById('form-title').textContent = isView ? "Visualizar Registro" : "Editar Registro";
            } else {
                limparFormulario();
                document.getElementById('form-title').textContent = "Nova Homologa√ß√£o";
            }
        };

        window.voltarParaLista = () => {
            document.getElementById('view-lista').style.display = 'flex';
            document.getElementById('view-formulario').style.display = 'none';
            const session = JSON.parse(localStorage.getItem('rh_session'));
            if(session.role === 'ADMIN') document.getElementById('btnNovo').style.display = 'inline-flex';
            window.carregarLista();
        };

        // --- L√ìGICA DA TABELA ---

        window.carregarLista = async () => {
            DADOS_LISTA = await DBHandler.listarHomologacoes();
            renderizarTabela(DADOS_LISTA);
        };

        function renderizarTabela(lista) {
            const tbody = document.querySelector("#homologTable tbody");
            tbody.innerHTML = lista.map(item => `
                <tr>
                    <td><strong>${item.colaboradores?.nome || '‚Äî'}</strong></td>
                    <td>${item.treinamentos?.nome || '‚Äî'}</td>
                    <td><span class="badge ${item.atividade_externa === 'NOTORIO' ? 'type-notorio' : 'type-cert'}">${item.atividade_externa}</span></td>
                    <td>${new Date(item.data_homologacao).toLocaleDateString('pt-BR')}</td>
                    <td>${item.nota || 'N/A'}</td>
                    <td style="text-align: right;">
                        <button class="btn-icon" onclick="window.abrirFormulario(${item.id}, true)">üëÅÔ∏è</button>
                        <button class="btn-icon admin-only" onclick="window.abrirFormulario(${item.id}, false)">‚úèÔ∏è</button>
                    </td>
                </tr>
            `).join('');
            
            // Re-aplica visibilidade
            const session = JSON.parse(localStorage.getItem('rh_session'));
            if(session.role !== 'ADMIN') document.querySelectorAll('tbody .admin-only').forEach(e => e.style.display = 'none');
        }

        window.filtrar = () => {
            const busca = document.getElementById('searchBox').value.toLowerCase();
            const tipo = document.getElementById('filterTipo').value;
            const filtrados = DADOS_LISTA.filter(i => {
                const matchBusca = i.colaboradores?.nome?.toLowerCase().includes(busca) || i.treinamentos?.nome?.toLowerCase().includes(busca);
                const matchTipo = tipo === 'TODOS' || i.atividade_externa === tipo;
                return matchBusca && matchTipo;
            });
            renderizarTabela(filtrados);
        };

        // --- L√ìGICA DO FORMUL√ÅRIO ---

        window.selectMode = (mode, el) => {
            currentMode = mode.toUpperCase();
            document.querySelectorAll('.evidence-button').forEach(b => b.classList.remove('active'));
            el.classList.add('active');
            document.getElementById('form-certificado').style.display = mode === 'certificado' ? 'block' : 'none';
            document.getElementById('form-notorio').style.display = mode === 'notorio' ? 'block' : 'none';
        };

        window.toggleInstituicao = (check) => {
            const input = document.getElementById('certInstituicao');
            input.value = check ? "Edesoft-Academy" : "";
            input.readOnly = check;
        };

        window.toggleNota = (check) => {
            const input = document.getElementById('certNota');
            input.readOnly = check;
            input.placeholder = check ? "N/A" : "0.0";
            if (check) input.value = "";
        };

        window.salvarHomologacao = async () => {
            const session = JSON.parse(localStorage.getItem('rh_session'));
            const payload = {
                colaborador_id: document.getElementById('selectColaborador').value,
                treinamento_id: document.getElementById('selectTreinamento').value,
                usuario_registro: session.user,
                atividade_externa: currentMode,
                data_homologacao: currentMode === 'CERTIFICADO' ? document.getElementById('certData').value : new Date().toISOString().split('T')[0],
                nota: (currentMode === 'CERTIFICADO' && !document.getElementById('checkNotaNA').checked) ? document.getElementById('certNota').value : null,
                instrutor: currentMode === 'CERTIFICADO' ? document.getElementById('certInstituicao').value : document.getElementById('notorioAprovador').value,
                observacoes: currentMode === 'NOTORIO' ? document.getElementById('notorioJustificativa').value : null
            };

            if (!payload.colaborador_id || !payload.treinamento_id) return alert("Selecione Colaborador e Compet√™ncia.");

            try {
                await DBHandler.salvarHomologacao({ ...(currentId ? { id: currentId } : {}), ...payload });
                alert("‚úÖ Registro gravado!");
                window.voltarParaLista();
            } catch (e) { alert("Erro: " + e.message); }
        };

        function preencherFormulario(d) {
            document.getElementById('selectColaborador').value = d.colaborador_id;
            document.getElementById('selectTreinamento').value = d.treinamento_id;
            if (d.atividade_externa === 'NOTORIO') {
                window.selectMode('notorio', document.getElementById('btn-notorio'));
                document.getElementById('notorioJustificativa').value = d.observacoes;
                document.getElementById('notorioAprovador').value = d.instrutor;
            } else {
                window.selectMode('certificado', document.getElementById('btn-cert'));
                document.getElementById('certInstituicao').value = d.instrutor;
                document.getElementById('certData').value = d.data_homologacao;
                if(d.nota) {
                    document.getElementById('checkNotaNA').checked = false;
                    window.toggleNota(false);
                    document.getElementById('certNota').value = d.nota;
                }
            }
        }

        function travarFormulario() {
            document.querySelectorAll('#view-formulario input, #view-formulario select, #view-formulario textarea').forEach(el => el.disabled = true);
            document.getElementById('btnSalvar').style.display = 'none';
        }

        function limparFormulario() {
            document.querySelectorAll('#view-formulario input, #view-formulario select, #view-formulario textarea').forEach(el => {
                el.disabled = false;
                el.value = "";
            });
            document.getElementById('btnSalvar').style.display = 'block';
            document.getElementById('certInstituicao').value = "Edesoft-Academy";
            document.getElementById('certInstituicao').readOnly = true;
            document.getElementById('checkEdesoft').checked = true;
            document.getElementById('checkNotaNA').checked = true;
            document.getElementById('certData').value = new Date().toISOString().split('T')[0];
            window.selectMode('certificado', document.getElementById('btn-cert'));
        }
    </script>
</body>
</html>
