<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Academy | Gest√£o de Certifica√ß√µes</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<style>
:root {
    --primary: #4f46e5;
    --primary-light: #6366f1;
    --primary-hover: #4338ca;
    --bg: #f4f6fa;
    --white: #ffffff;
    --border: #e2e8f0;
    --shadow: rgba(0, 0, 0, 0.05);

    --text-main: #1f2937;
    --text-muted: #475569;

    --view-blue: #2563eb;
    --edit-purple: #7c3aed;
    --delete-red: #dc2626;
}

* {
    box-sizing: border-box;
    font-family: 'Inter', sans-serif;
}

/* BODY */
body {
    margin: 0;
    background: var(--bg);
    color: var(--text-main);
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

/* HEADER */
.app-header {
    height: 60px;
    background: var(--white);
    border-bottom: 2px solid var(--border);
    padding: 0 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: 0 2px 4px var(--shadow);
}

.header-brand {
    font-size: 16px;
    font-weight: 800;
    color: var(--primary);
    letter-spacing: 0.05em;
}

/* FILTERS */
.filter-bar {
    background: var(--white);
    padding: 14px 24px;
    border-bottom: 1px solid var(--border);
    display: flex;
    flex-wrap: wrap;
    gap: 14px;
    align-items: flex-end;
    box-shadow: 0 1px 3px var(--shadow);
}

.filter-inner {
    max-width: 920px;
    width: 100%;
    display: flex;
    flex-wrap: wrap;
    gap: 14px;
    align-items: flex-end;
    margin: 0 auto;
}

.filter-group {
    display: flex;
    flex-direction: column;
    gap: 4px;
    min-width: 160px;
    flex: 1 1 220px;
}

.filter-group label {
    font-size: 12px;
    font-weight: 700;
    color: var(--text-muted);
}

.control-slim {
    height: 38px;
    padding: 0 12px;
    font-size: 14px;
    border: 1px solid var(--border);
    border-radius: 8px;
    background: var(--white);
    transition: 0.2s;
    box-shadow: 0 1px 2px rgba(0,0,0,0.08);
}

.control-slim:focus {
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(79,70,229,0.15);
    outline: none;
}

/* BUTTONS */
.btn {
    height: 38px;
    padding: 0 18px;
    border-radius: 8px;
    font-weight: 700;
    font-size: 13px;
    cursor: pointer;
    transition: 0.2s;
}

.btn-primary {
    background: linear-gradient(133deg, var(--primary-light), var(--primary));
    color: var(--white);
    border: none;
    box-shadow: 0 2px 6px var(--shadow);
}

.btn-primary:hover {
    background: var(--primary-hover);
}

.btn-outline {
    background: var(--white);
    border: 1px solid var(--primary-light);
    color: var(--primary);
}

.btn-outline:hover {
    background: var(--primary-light);
    color: var(--white);
}

/* TABLE AREA */
.table-area {
    flex: 1;
    overflow: auto;
    padding: 16px 24px;
}

table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    background: var(--white);
    border-radius: 10px;
    border: 1px solid var(--border);
    box-shadow: 0 1px 3px var(--shadow);
}

th {
    background: #fafbfc;
    padding: 10px 14px;
    font-size: 11px;
    font-weight: 700;
    color: var(--text-muted);
    border-bottom: 1px solid var(--border);
    text-transform: uppercase;
}

td {
    padding: 8px 14px;
    font-size: 13px;
    color: var(--text-main);
}

tr:hover td {
    background: #fcfdfe;
}

/* ACTION BUTTONS */
.btn-action {
    width: 30px; height: 30px;
    border-radius: 8px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 15px;
    transition: 0.2s;
}

.btn-view { background: #e0ebff; color: var(--view-blue); }
.btn-edit { background: #f3e8ff; color: var(--edit-purple); }
.btn-delete { background: #fee9e9; color: var(--delete-red); }

.btn-view:hover { background: #d1dfff; }
.btn-edit:hover { background: #e7d9ff; }
.btn-delete:hover { background: #ffd4d4; }

/* BADGES */
.badge {
    padding: 3px 8px;
    border-radius: 6px;
    font-size: 10px;
    font-weight: 800;
    text-transform: uppercase;
}

.type-cert { background: #e6ecff; color: #3f51b5; }
.type-notorio { background: #fff4e5; color: #b35c00; }

/* FORM VIEW */
#view-formulario {
    flex: 1;
    display: none;
    overflow: hidden;
}
#view-formulario.active { display: flex; }

.form-layout { display: flex; width: 100%; height: 100%; }

.form-sidebar {
    width: 280px;
    background: var(--white);
    border-right: 1px solid var(--border);
    padding: 24px;
}

.form-main {
    flex: 1;
    padding: 32px;
    background: var(--bg);
    overflow-y: auto;
    display: flex;
    justify-content: center;
}

.form-card {
    width: 100%;
    max-width: 700px;
    background: var(--white);
    padding: 32px;
    border-radius: 12px;
    border: 1px solid var(--border);
    box-shadow: 0 4px 8px var(--shadow);
}

.field-label {
    font-size: 11px;
    font-weight: 800;
    color: var(--text-muted);
    text-transform: uppercase;
    margin-bottom: 6px;
}

/* UTIL */
.readonly-mode .input-full {
    background: #f1f5f9;
    border-style: dashed;
    pointer-events: none;
    color: #475569;
}

.admin-only { display: none; }
</style>


</head>
<body>

    <header class="app-header">
        <div class="header-brand">ACADEMY // GEST√ÉO DE COMPET√äNCIAS</div>
        <button class="btn btn-primary admin-only" id="btnNovo" onclick="window.abrirFormulario()">‚ûï NOVO REGISTRO</button>
    </header>

    <div id="view-lista" class="active">


<div class="filter-bar">
  <div class="filter-inner">
    <div class="filter-group" style="flex: 1;">
      <label>Pesquisar</label>
      <input type="text" id="searchBox" class="control-slim" placeholder="Buscar..." onkeyup="window.filtrar()">
    </div>

    <div class="filter-group" style="width: 160px;">
      <label>Tipo</label>
      <select id="filterTipo" class="control-slim" onchange="window.filtrar()">
        <option value="TODOS">Todos</option>
        <option value="CERTIFICADO">Certificado</option>
        <option value="NOTORIO">Not√≥rio</option>
      </select>
    </div>

    <div style="display: flex; align-items: flex-end;">
      <button class="btn btn-outline" onclick="window.limparFiltros()">LIMPAR</button>
    </div>
  </div>
</div>


        


        
        <div class="table-area">
            <table id="homologTable">
                <thead>
                    <tr>
                        <th style="width: 30%;">Colaborador</th>
                        <th style="width: 30%;">Compet√™ncia Alvo</th>
                        <th style="width: 15%;">Tipo</th>
                        <th style="width: 15%;">Data</th>
                        <th style="width: 5%;">Nota</th>
                        <th style="text-align: right; width: 5%;">A√ß√µes</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="view-formulario">
        <div class="form-layout" id="formWrapper">
            <aside class="form-sidebar">
                <div>
                    <span class="field-label">1. Benefici√°rio</span>
                    <select id="selectColaborador" class="input-full"><option value="">Carregando...</option></select>
                </div>
                <div>
                    <span class="field-label">2. Compet√™ncia</span>
                    <select id="selectTreinamento" class="input-full"><option value="">Carregando...</option></select>
                </div>
                <div id="tipoBox">
                    <span class="field-label">3. Origem</span>
                    <div id="btn-cert" class="mode-card active" onclick="window.selectMode('certificado', this)">
                        Certificado Externo
                    </div>
                    <div id="btn-notorio" class="mode-card" onclick="window.selectMode('notorio', this)">
                        Not√≥rio Saber
                    </div>
                </div>
            </aside>

            <main class="form-main">
                <div class="form-card">
                    <h2 id="form-title" style="margin: 0 0 24px 0; font-size: 18px; font-weight: 800; border-bottom: 2px solid var(--bg); padding-bottom: 10px;">Ficha de Registro</h2>

                    <div id="form-certificado">
                        <div style="display: flex; gap: 16px;">
                            <div style="flex: 1;">
                                <span class="field-label">Institui√ß√£o</span>
                                <input type="text" id="certInstituicao" class="input-full" value="Edesoft-Academy" readonly>
                                <label style="display:flex; align-items:center; gap:5px; font-size:11px; margin-top:-10px;">
                                    <input type="checkbox" id="checkEdesoft" checked onchange="window.toggleInstituicao(this.checked)"> Edesoft Academy
                                </label>
                            </div>
                            <div style="width: 150px;">
                                <span class="field-label">Data de Conclus√£o</span>
                                <input type="date" id="certData" class="input-full">
                            </div>
                        </div>
                        <div style="display: flex; gap: 16px; margin-top: 15px;">
                            <div style="width: 100px;">
                                <span class="field-label">Nota</span>
                                <input type="number" id="certNota" class="input-full" placeholder="N/A" readonly step="0.1">
                                <label style="display:flex; align-items:center; gap:5px; font-size:11px; margin-top:-10px;">
                                    <input type="checkbox" id="checkNotaNA" checked onchange="window.toggleNota(this.checked)"> N/A
                                </label>
                            </div>
                            <div style="flex: 1;">
                                <span class="field-label">Link do Certificado (URL)</span>
                                <input type="url" id="certLink" class="input-full" placeholder="https://...">
                            </div>
                        </div>
                    </div>

                    <div id="form-notorio" style="display: none;">
                        <span class="field-label">Justificativa do RH</span>
                        <textarea id="notorioJustificativa" class="input-full" style="height: 120px;" placeholder="Detalhes da valida√ß√£o..."></textarea>
                        <span class="field-label">Aprovador T√©cnico</span>
                        <input type="text" id="notorioAprovador" class="input-full" placeholder="Nome do gestor respons√°vel">
                        <div id="rhCheckRow" style="background: #f8fafc; padding: 12px; border-radius: 8px; border: 1px solid var(--border); display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="checkRH" style="width: 18px; height: 18px;">
                            <span style="font-size: 11px; font-weight: 700;">REGISTRO VALIDADO CONFORME POL√çTICA INTERNA.</span>
                        </div>
                    </div>

                    <div class="footer">
                        <button class="btn btn-outline" onclick="window.voltarParaLista()">CANCELAR</button>
                        <button class="btn btn-primary" id="btnSalvar" onclick="window.salvarHomologacao()">GRAVAR DADOS</button>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script type="module">
        import { DBHandler } from '../bd-treinamentos/db-handler.js';
        let DADOS_LISTA = [];
        let currentId = null;
        let currentMode = 'CERTIFICADO';

        // --- SETUP ---
        document.addEventListener('DOMContentLoaded', async () => {
            const session = JSON.parse(localStorage.getItem('rh_session')) || { role: 'VIEWER' };
            if (session.role === 'ADMIN') document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'inline-flex');
            await carregarCombos();
            await window.carregarLista();
        });

        async function carregarCombos() {
            try {
                const colabs = await DBHandler.listarColaboradores({ somenteAtivos: true });
                document.getElementById('selectColaborador').innerHTML = '<option value="">Selecione...</option>' + 
                    colabs.map(c => `<option value="${c.id}">${c.nome}</option>`).join('');
                const { treinamentos } = await DBHandler.carregarDadosIniciais();
                document.getElementById('selectTreinamento').innerHTML = '<option value="">Selecione...</option>' + 
                    treinamentos.map(t => `<option value="${t.id}">${t.nome}</option>`).join('');
            } catch (e) { console.error(e); }
        }

        // --- NAVEGA√á√ÉO SPA ---
        window.abrirFormulario = async (id = null, visualizar = false) => {
            currentId = id;
            if (id) {
                const dado = await DBHandler.buscarHomologacaoPorId(id);
                preencherCampos(dado);
                travarCampos(visualizar);
                document.getElementById('form-title').textContent = visualizar ? 'CONSULTA DE REGISTRO' : 'EDI√á√ÉO DE REGISTRO';
            } else {
                limparFormulario();
                travarCampos(false);
                document.getElementById('form-title').textContent = 'NOVO REGISTRO';
            }
            document.getElementById('view-lista').classList.remove('active');
            document.getElementById('view-formulario').classList.add('active');
        };

        window.voltarParaLista = () => {
            document.getElementById('view-formulario').classList.remove('active');
            document.getElementById('view-lista').classList.add('active');
            window.carregarLista();
        };

        // --- DASHBOARD ---
        window.carregarLista = async () => {
            DADOS_LISTA = await DBHandler.listarHomologacoes();
            renderizarTabela(DADOS_LISTA);
        };

        function renderizarTabela(lista) {
            const tbody = document.querySelector("#homologTable tbody");
            const session = JSON.parse(localStorage.getItem('rh_session')) || {};
            tbody.innerHTML = lista.map(item => `
                <tr>
                    <td><strong>${item.colaboradores?.nome || '‚Äî'}</strong></td>
                    <td>${item.treinamentos?.nome || '‚Äî'}</td>
                    <td><span class="badge ${item.atividade_externa === 'NOTORIO' ? 'type-notorio' : 'type-cert'}">${item.atividade_externa}</span></td>
                    <td>${item.data_homologacao ? new Date(item.data_homologacao).toLocaleDateString('pt-BR') : '‚Äî'}</td>
                    <td>${item.nota || '‚Äî'}</td>
                    <td style="text-align: right; white-space: nowrap;">
                        <button class="btn-action btn-view" onclick="window.abrirFormulario(${item.id}, true)">üëÅÔ∏è</button>
                        ${session.role === 'ADMIN' ? `
                            <button class="btn-action btn-edit" onclick="window.abrirFormulario(${item.id}, false)">‚úèÔ∏è</button>
                            <button class="btn-action btn-delete" onclick="window.deletarRegistro(${item.id})">üóëÔ∏è</button>
                        ` : ''}
                    </td>
                </tr>
            `).join('');
        }

        window.filtrar = () => {
            const busca = document.getElementById('searchBox').value.toLowerCase();
            const tipo = document.getElementById('filterTipo').value;
            renderizarTabela(DADOS_LISTA.filter(i =>
                ((i.colaboradores?.nome || "").toLowerCase().includes(busca) ||
                 (i.treinamentos?.nome || "").toLowerCase().includes(busca)) &&
                (tipo === 'TODOS' || i.atividade_externa === tipo)
            ));
        };

        window.limparFiltros = () => {
            document.getElementById('searchBox').value = "";
            document.getElementById('filterTipo').value = "TODOS";
            renderizarTabela(DADOS_LISTA);
        };

        // --- L√ìGICA FORMUL√ÅRIO ---
        window.selectMode = (mode, el) => {
            currentMode = mode.toUpperCase();
            document.querySelectorAll('.mode-card').forEach(b => b.classList.remove('active'));
            el.classList.add('active');
            document.getElementById('form-certificado').style.display = mode === 'certificado' ? 'block' : 'none';
            document.getElementById('form-notorio').style.display = mode === 'notorio' ? 'block' : 'none';
        };

        window.toggleInstituicao = (check) => {
            const input = document.getElementById('certInstituicao');
            input.value = check ? "Edesoft-Academy" : "";
            input.readOnly = check;
        };

        window.toggleNota = (check) => {
            const input = document.getElementById('certNota');
            input.readOnly = check;
            input.placeholder = check ? "N/A" : "0.0";
            if (check) input.value = "";
        };

        window.salvarHomologacao = async () => {
            const session = JSON.parse(localStorage.getItem('rh_session'));
            const payload = {
                colaborador_id: document.getElementById('selectColaborador').value,
                treinamento_id: document.getElementById('selectTreinamento').value,
                usuario_registro: session.user,
                atividade_externa: currentMode,
                data_homologacao: currentMode === 'CERTIFICADO' ? document.getElementById('certData').value : new Date().toISOString().split('T')[0],
                nota: (currentMode === 'CERTIFICADO' && !document.getElementById('checkNotaNA').checked) ? document.getElementById('certNota').value : null,
                instrutor: currentMode === 'CERTIFICADO' ? document.getElementById('certInstituicao').value : document.getElementById('notorioAprovador').value,
                observacoes: currentMode === 'NOTORIO' ? document.getElementById('notorioJustificativa').value : document.getElementById('certLink').value
            };
            try {
                await DBHandler.salvarHomologacao({ ...(currentId ? { id: currentId } : {}), ...payload });
                alert("Gravado!");
                window.voltarParaLista();
            } catch (e) { alert(e.message); }
        };

        window.deletarRegistro = async (id) => {
            if (!confirm('Excluir permanentemente?')) return;
            try { await DBHandler.excluirHomologacao(id); await window.carregarLista(); } catch (e) { alert(e.message); }
        };

        function preencherCampos(d) {
            document.getElementById('selectColaborador').value = d.colaborador_id;
            document.getElementById('selectTreinamento').value = d.treinamento_id;
            if (d.atividade_externa === 'NOTORIO') {
                window.selectMode('notorio', document.getElementById('btn-notorio'));
                document.getElementById('notorioJustificativa').value = d.observacoes || "";
                document.getElementById('notorioAprovador').value = d.instrutor || "";
            } else {
                window.selectMode('certificado', document.getElementById('btn-cert'));
                document.getElementById('certInstituicao').value = d.instrutor;
                document.getElementById('checkEdesoft').checked = (d.instrutor === "Edesoft-Academy");
                document.getElementById('certData').value = d.data_homologacao;
                document.getElementById('certLink').value = d.observacoes || "";
                if(d.nota) { document.getElementById('checkNotaNA').checked = false; window.toggleNota(false); document.getElementById('certNota').value = d.nota; }
            }
        }

        function travarCampos(travar) {
            document.querySelectorAll('#view-formulario input, #view-formulario select, #view-formulario textarea').forEach(el => el.disabled = travar);
            document.getElementById('btnSalvar').style.display = travar ? 'none' : 'inline-flex';
            document.getElementById('rhCheckRow').style.display = travar ? 'none' : 'flex';
            document.getElementById('tipoBox').style.pointerEvents = travar ? 'none' : 'auto';
            document.getElementById('formWrapper').classList.toggle('readonly-mode', travar);
        }

        function limparFormulario() {
            document.querySelectorAll('#view-formulario input, #view-formulario select, #view-formulario textarea').forEach(el => el.value = "");
            document.getElementById('certInstituicao').value = "Edesoft-Academy";
            document.getElementById('checkEdesoft').checked = true;
            document.getElementById('checkNotaNA').checked = true;
            document.getElementById('certData').value = new Date().toISOString().split('T')[0];
            window.selectMode('certificado', document.getElementById('btn-cert'));
        }
    </script>
</body>
</html>







