<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administração do Sistema | Academy</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #4f46e5; --primary-hover: #4338ca; --danger: #ef4444; 
            --success: #10b981; --warning: #f59e0b; --bg-gray: #f1f5f9;
            --text-main: #0f172a; --border-color: #cbd5e1;
        }

        /* --- ESTRUTURA DASHBOARD --- */
        * { box-sizing: border-box; }
        html, body { height: 100vh; margin: 0; padding: 0; overflow: hidden; display: flex; flex-direction: column; background-color: var(--bg-gray); font-family: 'Inter', sans-serif; }

        .top-bar { flex-shrink: 0; height: 56px; background: #fff; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; padding: 0 24px; }
        .top-bar h1 { font-size: 14px; font-weight: 700; color: var(--text-main); text-transform: uppercase; }

        .main-workspace { flex: 1; display: flex; flex-direction: column; padding: 20px; overflow: hidden; align-items: center; }
        .admin-card { background: #fff; width: 100%; max-width: 1300px; height: 100%; border-radius: 12px; border: 1px solid var(--border-color); display: flex; flex-direction: column; overflow: hidden; }
        
        .tabs-header { flex-shrink: 0; display: flex; background: #f8fafc; border-bottom: 1px solid #e2e8f0; padding: 0 12px; }
        .tab-btn { padding: 14px 20px; border: none; background: none; font-size: 12px; font-weight: 600; color: #64748b; cursor: pointer; border-bottom: 2px solid transparent; }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); background: #eff6ff; }

        .card-body { flex: 1; padding: 24px; display: none; overflow-y: auto; }
        .card-body.active { display: block; }

        /* --- TABELAS & COMPONENTES --- */
        .matrix-container { overflow-x: auto; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 15px; }
        .perm-table { width: 100%; border-collapse: collapse; font-size: 11px; }
        .perm-table th { background: #f8fafc; padding: 12px; border-bottom: 2px solid #e2e8f0; position: sticky; top: 0; z-index: 10; }
        .perm-table td { padding: 10px; border-bottom: 1px solid #f1f5f9; text-align: center; }
        .perm-table td:first-child { text-align: left; font-weight: 600; padding-left: 15px; }

        .btn-action { background: var(--primary); color: white; border: none; padding: 8px 16px; border-radius: 6px; font-weight: 600; font-size: 12px; cursor: pointer; }
        .btn-action:disabled { background: #e2e8f0; color: #94a3b8; }
        .btn-cancel { background: #fff; color: #64748b; border: 1px solid #cbd5e1; padding: 8px 16px; border-radius: 6px; font-weight: 600; display: none; }
        
        .highlight-change { background-color: #eef2ff !important; border: 1px solid var(--primary) !important; }
        .log-details-cell { text-align: left !important; font-size: 10px; white-space: pre-line; color: #475569; }
        .filter-bar { background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0; margin-bottom: 20px; display: flex; align-items: flex-end; gap: 15px; }
    </style>
</head>
<body>

    <header class="top-bar"><h1>Administração do Sistema</h1></header>

    <main class="main-workspace">
        <div class="admin-card">
            <nav class="tabs-header">
                <button class="tab-btn active" data-tab="status">Status</button>
                <button class="tab-btn" data-tab="permissoes">Matriz</button>
                <button class="tab-btn" data-tab="usuarios">Usuários</button>
                <button class="tab-btn" data-tab="logs">Logs de Auditoria</button>
            </nav>

            <div id="tab-status" class="card-body active"><div id="metaInfo"></div></div>

            <div id="tab-permissoes" class="card-body">
                <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                    <span style="font-size: 12px; color: #64748b;">Alterações pendentes em azul.</span>
                    <div style="display: flex; gap: 10px;">
                        <button id="btnCancelarMatriz" class="btn-cancel" onclick="window.cancelarAlteracoesMatriz()">Cancelar</button>
                        <button id="btnSalvarPermissoes" class="btn-action" disabled>Gravar Matriz</button>
                    </div>
                </div>
                <div class="matrix-container"><table class="perm-table"><thead><tr id="headerRoles"><th>Módulo</th></tr></thead><tbody id="permTableBody"></tbody></table></div>
            </div>

            <div id="tab-usuarios" class="card-body">
                <div id="gridUsuarios" style="display: grid; grid-template-columns: 320px 1fr; gap: 30px;">
                    <div id="containerFormNovo" style="background:#f8fafc; padding:20px; border-radius:8px; border:1px solid #e2e8f0; height:fit-content;">
                        <h3 style="font-size:14px; margin-bottom:15px;">Novo Usuário</h3>
                        <form id="formNovoUsuario">
                            <input type="text" id="addNome" placeholder="Nome" style="width:100%; padding:8px; margin-bottom:10px;" required>
                            <input type="text" id="addLogin" placeholder="Login" style="width:100%; padding:8px; margin-bottom:10px;" required>
                            <input type="password" id="addSenha" placeholder="Senha" style="width:100%; padding:8px; margin-bottom:10px;" required>
                            <select id="addRole" style="width:100%; padding:8px; margin-bottom:20px;"></select>
                            <button type="submit" class="btn-action" style="width:100%;">Criar Conta</button>
                        </form>
                    </div>
                    <div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                            <h3 style="font-size:14px;">Lista de Acessos</h3>
                            <div style="display: flex; gap: 10px;">
                                <button id="btnCancelarUsuarios" class="btn-cancel" onclick="window.carregarUsuarios()">Descartar</button>
                                <button id="btnSalvarUsuarios" class="btn-action" disabled onclick="window.salvarAlteracoesUsuarios()">Salvar Cargos</button>
                            </div>
                        </div>
                        <div class="matrix-container"><table class="perm-table"><thead><tr><th style="text-align:left; padding-left:15px;">Nome</th><th>Login</th><th>Cargo</th><th>Ações</th></tr></thead><tbody id="listaUsuariosBody"></tbody></table></div>
                    </div>
                </div>
            </div>

            <div id="tab-logs" class="card-body">
                <div class="filter-bar">
                    <div style="display: flex; gap: 10px;">
                        <input type="date" id="logDateInicio" class="filter-input">
                        <input type="date" id="logDateFim" class="filter-input">
                    </div>
                    <select id="logFilterTela" class="filter-input" style="min-width: 250px;">
                        <option value="">Selecione uma tela...</option>
                    </select>
                    <button class="btn-action" onclick="window.carregarLogs()">Filtrar Logs</button>
                </div>
                <div class="matrix-container">
                    <table class="perm-table">
                        <thead><tr><th>Data</th><th>Usuário</th><th>Ação</th><th>Detalhes</th><th>Tela</th></tr></thead>
                        <tbody id="listaLogsBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        import { DBHandler, supabaseClient } from '../bd-treinamentos/db-handler.js';

        const ROLES = ['ADMIN', 'TD_COORD', 'RH_OPERACIONAL', 'GESTOR', 'AUDITOR', 'COLABORADOR'];
        let originalMatrixState = [];
        let modulosLabelMap = {};

        document.addEventListener('DOMContentLoaded', () => {
            verificarModoLeitura();
            configurarAbas();
            carregarStatus();
            initMatrix();
            popularRoles();
            setarDatas();
        });

        // --- FILTROS DE LOG (DINÂMICO) ---
        async function popularFiltroTelas() {
            const s = document.getElementById('logFilterTela');
            if(!s) return;

            try {
                // Seleciona todas as telas que já foram registradas na tabela de logs
                const { data, error } = await supabaseClient.from('logs_sistema').select('tela');
                if(error) throw error;

                // Extrai valores únicos
                const telasUnicas = [...new Set(data.map(l => l.tela).filter(t => t))].sort();
                
                if(telasUnicas.length > 0) {
                    s.innerHTML = telasUnicas.map(t => `<option value="${t}">${t}</option>`).join('');
                } else {
                    s.innerHTML = '<option value="">Nenhum log registrado</option>';
                }
            } catch(e) {
                s.innerHTML = '<option value="">Erro ao carregar telas</option>';
            }
        }

        function configurarAbas() {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.onclick = () => {
                    document.querySelectorAll('.tab-btn, .card-body').forEach(el => el.classList.remove('active'));
                    btn.classList.add('active');
                    document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
                    
                    if (btn.dataset.tab === 'usuarios') carregarUsuarios();
                    if (btn.dataset.tab === 'logs') {
                        popularFiltroTelas(); // Chamada crucial ao abrir a aba
                    }
                };
            });
        }

        // --- RESTANTE DAS FUNÇÕES ---
        function setarDatas() {
            const h = new Date(); const p = new Date(); p.setDate(h.getDate() - 30);
            document.getElementById('logDateFim').value = h.toISOString().split('T')[0];
            document.getElementById('logDateInicio').value = p.toISOString().split('T')[0];
        }

        function popularRoles() {
            const s = document.getElementById('addRole');
            if(s) s.innerHTML = ROLES.map(r => `<option value="${r}">${r}</option>`).join('');
        }

        async function carregarStatus() {
            const { count } = await supabaseClient.from('usuarios_sistema').select('*', { count: 'exact', head: true });
            document.getElementById('metaInfo').innerHTML = `<div style="padding:15px; background:#eff6ff; border-radius:8px; border:1px solid #dbeafe; display:inline-block;"><span style="font-size:11px; color:#1d4ed8; font-weight:700;">CONEXÃO ATIVA</span><br><strong>${count} usuários cadastrados.</strong></div>`;
        }

        async function initMatrix() {
            const h = document.getElementById('headerRoles');
            const b = document.getElementById('permTableBody');
            h.innerHTML = '<th>Módulo</th>';
            ROLES.forEach(r => h.innerHTML += `<th colspan="3" style="border-left:1px solid #e2e8f0;">${r}</th>`);
            const { data: mods } = await supabaseClient.from('modulos_sistema').select('*').order('ordem');
            const { data: acc } = await supabaseClient.from('acesso_modulos').select('*');
            originalMatrixState = acc;
            b.innerHTML = '';
            mods.forEach(m => {
                modulosLabelMap[m.id] = m.label;
                const tr = document.createElement('tr');
                let html = `<td>${m.label}</td>`;
                ROLES.forEach(role => {
                    const a = acc.find(x => x.modulo_id === m.id && x.role === role);
                    html += `<td style="border-left:1px solid #f1f5f9;"><input type="checkbox" class="matrix-cb" data-mod="${m.id}" data-role="${role}" data-type="Ver" ${a ? 'checked' : ''} onchange="window.verificarMatrix()"></td><td><input type="checkbox" class="matrix-cb" data-mod="${m.id}" data-role="${role}" data-type="Editar" ${a?.pode_editar ? 'checked' : ''} onchange="window.verificarMatrix()"></td><td><input type="checkbox" class="matrix-cb" data-mod="${m.id}" data-role="${role}" data-type="Detalhes" ${a?.ver_detalhes ? 'checked' : ''} onchange="window.verificarMatrix()"></td>`;
                });
                tr.innerHTML = html; b.appendChild(tr);
            });
            window.verificarMatrix();
        }

        window.verificarMatrix = () => {
            const cbs = document.querySelectorAll('.matrix-cb');
            let dirty = false;
            cbs.forEach(cb => {
                const a = originalMatrixState.find(x => x.modulo_id == cb.dataset.mod && x.role == cb.dataset.role);
                let orig = false;
                if(cb.dataset.type === 'Ver') orig = !!a;
                if(cb.dataset.type === 'Editar') orig = a?.pode_editar || false;
                if(cb.dataset.type === 'Detalhes') orig = a?.ver_detalhes || false;
                if (cb.checked !== orig) { cb.parentElement.classList.add('highlight-change'); dirty = true; } 
                else { cb.parentElement.classList.remove('highlight-change'); }
            });
            document.getElementById('btnSalvarPermissoes').disabled = !dirty;
            document.getElementById('btnCancelarMatriz').style.display = dirty ? 'block' : 'none';
        }

        window.cancelarAlteracoesMatriz = () => initMatrix();

        document.getElementById('btnSalvarPermissoes').onclick = async () => {
            const sess = JSON.parse(localStorage.getItem('rh_session'));
            const payload = [];
            ROLES.forEach(r => {
                document.querySelectorAll(`.matrix-cb[data-role="${r}"][data-type="Ver"]:checked`).forEach(cv => {
                    const mid = cv.dataset.mod;
                    payload.push({ 
                        role: r, modulo_id: parseInt(mid), 
                        pode_editar: document.querySelector(`.matrix-cb[data-mod="${mid}"][data-role="${r}"][data-type="Editar"]`).checked,
                        ver_detalhes: document.querySelector(`.matrix-cb[data-mod="${mid}"][data-role="${r}"][data-type="Detalhes"]`).checked
                    });
                });
            });
            await supabaseClient.from('acesso_modulos').delete().neq('id', 0);
            if(payload.length > 0) await supabaseClient.from('acesso_modulos').insert(payload);
            await DBHandler.registrarLog(sess.user, "ATUALIZAR_MATRIZ", "Matriz atualizada", "Administração");
            alert("Sucesso!"); initMatrix();
        };

        async function carregarUsuarios() {
            const body = document.getElementById('listaUsuariosBody');
            const { data } = await supabaseClient.from('usuarios_sistema').select('*').order('nome');
            body.innerHTML = '';
            data.forEach(u => {
                const opt = ROLES.map(r => `<option value="${r}" ${u.role === r ? 'selected' : ''}>${r}</option>`).join('');
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${u.nome}</td><td>${u.username}</td><td><select class="user-sel" data-id="${u.id}" data-orig="${u.role}" onchange="window.verificarUser()">${opt}</select></td><td><button class="btn-action" style="background:#f59e0b" onclick="window.redefinirSenha('${u.id}','${u.nome}')">Senha</button></td>`;
                body.appendChild(tr);
            });
        }

        window.redefinirSenha = async (id, nome) => {
            const s = prompt(`Nova senha para ${nome}:`);
            if(s) {
                await supabaseClient.from('usuarios_sistema').update({ password: s }).eq('id', id);
                alert("Senha alterada!");
            }
        }

        window.carregarLogs = async () => {
            const body = document.getElementById('listaLogsBody');
            const d1 = document.getElementById('logDateInicio').value;
            const d2 = document.getElementById('logDateFim').value;
            const tela = document.getElementById('logFilterTela').value;
            
            body.innerHTML = '<tr><td colspan="5">Consultando...</td></tr>';
            const { data } = await supabaseClient.from('logs_sistema').select('*').eq('tela', tela).gte('created_at', d1+'T00:00:00').lte('created_at', d2+'T23:59:59').order('created_at', {ascending: false});
            
            body.innerHTML = data.length ? '' : '<tr><td colspan="5">Nenhum registro encontrado.</td></tr>';
            data.forEach(l => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${new Date(l.created_at).toLocaleString()}</td><td>${l.usuario}</td><td>${l.acao}</td><td class="log-details-cell">${l.detalhes}</td><td>${l.tela}</td>`;
                body.appendChild(tr);
            });
        }

        function verificarModoLeitura() {
            if (new URLSearchParams(window.location.search).get('readonly') === 'true') {
                const obs = new MutationObserver(() => {
                    document.querySelectorAll('input, select, button').forEach(el => el.disabled = true);
                });
                obs.observe(document.body, { childList: true, subtree: true });
            }
        }
    </script>
</body>
</html>
